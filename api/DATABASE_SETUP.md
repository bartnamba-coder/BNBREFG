# Database Setup Guide

This guide explains how to set up the databases for both the Referral System and the Attestation System.

## Overview

The application uses two separate databases:

1. **Referral Database**: Stores basic referral codes and their associated wallet addresses
2. **Attestation Database**: Stores global referral counts, purchase history, and attestation logs

## Setup Instructions

### 1. Create the Databases

First, create two separate databases in your MySQL server:

```sql
CREATE DATABASE your_referral_database;
CREATE DATABASE your_attestation_database;
```

Replace `your_referral_database` and `your_attestation_database` with your preferred database names.

### 2. Create Database Users

Create users with appropriate permissions for each database:

```sql
-- For referral database
CREATE USER 'referral_db_user'@'localhost' IDENTIFIED BY 'your_secure_password';
GRANT ALL PRIVILEGES ON your_referral_database.* TO 'referral_db_user'@'localhost';

-- For attestation database
CREATE USER 'attestation_db_user'@'localhost' IDENTIFIED BY 'your_secure_password';
GRANT ALL PRIVILEGES ON your_attestation_database.* TO 'attestation_db_user'@'localhost';

FLUSH PRIVILEGES;
```

Replace `your_secure_password` with strong, unique passwords.

### 3. Create Tables

#### For Referral Database

Use the `setup_referral_db.sql` script to create the necessary tables:

```bash
mysql -u referral_db_user -p your_referral_database < setup_referral_db.sql
```

Or run the SQL commands directly in phpMyAdmin:

1. Select your referral database
2. Go to the SQL tab
3. Copy and paste the contents of `setup_referral_db.sql`
4. Click "Go"

#### For Attestation Database

Use the `setup_attestation_db.sql` script to create the necessary tables:

```bash
mysql -u attestation_db_user -p your_attestation_database < setup_attestation_db.sql
```

Or run the SQL commands directly in phpMyAdmin:

1. Select your attestation database
2. Go to the SQL tab
3. Copy and paste the contents of `setup_attestation_db.sql`
4. Click "Go"

### 4. Update Configuration

Update the database configuration in `config.php`:

```php
// Referral System Database Configuration
$referral_db_config = [
    'host' => 'localhost',
    'dbname' => 'your_referral_database',  // Your referral database name
    'username' => 'referral_db_user',      // Your referral database username
    'password' => 'your_secure_password',  // Your referral database password
];

// Attestation System Database Configuration
$attestation_db_config = [
    'host' => 'localhost',
    'dbname' => 'your_attestation_database',  // Your attestation database name
    'username' => 'attestation_db_user',      // Your attestation database username
    'password' => 'your_secure_password',     // Your attestation database password
];
```

### 5. Test the Connection

Access the `test_connections.php` script in your browser to verify that both database connections are working correctly.

## Table Descriptions

### Referral Database Tables

#### referral_codes
- Stores referral codes and their associated wallet addresses
- Used by the basic referral system for code lookup and creation

### Attestation Database Tables

#### global_referral_counts
- Tracks the total number of referrals for each referrer across all blockchains
- Used to determine referral tiers for cross-chain benefits

#### referral_purchases
- Records all purchases made with referral codes
- Includes chain ID, transaction hash, and USD amount

#### attestation_logs
- Logs all attestations generated by the system
- Used for debugging, auditing, and security monitoring

## Troubleshooting

If you encounter database connection issues:

1. Verify your database credentials in `config.php`
2. Check that the databases and tables exist
3. Ensure the database users have the correct permissions
4. Check the PHP error logs for specific error messages
5. Run `test_connections.php` to diagnose connection issues